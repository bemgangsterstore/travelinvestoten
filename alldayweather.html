<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oten Lua & Weather â€¢ GÃ³tico GalÃ¡ctico</title>

<!-- Fonts & libraries -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>
  :root{
    --bg1:#020218; --bg2:#07132a; --bg3:#001a36;
    --card-bg: rgba(10,14,20,0.9);
    --neon1:#cf8bf3; --neon2:#00f3ff; --accent:#a770ef; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;font-family:"Cinzel",serif;background:#000;color:#eaf6ff;overflow-x:hidden}

  /* Galactic animated background */
  body::before{
    content:"";
    position:fixed;inset:0;z-index:-4;
    background:
      radial-gradient(600px 300px at 10% 20%, rgba(255,120,200,0.06), transparent 10%),
      radial-gradient(800px 400px at 80% 70%, rgba(0,200,255,0.04), transparent 12%),
      linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
    background-size:300% 300%;
    animation:bgMove 28s linear infinite;
    filter:blur(6px) saturate(120%);
  }
  @keyframes bgMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  /* twinkling stars */
  .stars{position:fixed;inset:0;pointer-events:none;z-index:-3}
  .star{position:absolute;border-radius:50%;background:rgba(255,255,255,0.9);box-shadow:0 0 6px rgba(255,255,255,0.08);opacity:.8;animation:twinkle 3s linear infinite}
  @keyframes twinkle{0%{opacity:.15}50%{opacity:1}100%{opacity:.15}}

  header{
    position:sticky;top:0;background:linear-gradient(90deg,rgba(3,6,12,0.8),rgba(5,8,20,0.6));
    padding:18px;text-align:center;font-family:"Orbitron",sans-serif;font-size:20px;color:#fff;text-shadow:0 0 12px var(--neon1),0 0 20px var(--neon2);
    z-index:50;border-bottom:1px solid rgba(255,255,255,0.03);
  }

  .wrap{max-width:1280px;margin:28px auto;padding:0 16px 140px}

  /* Grid for forecast cards */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-bottom:22px}
  @media(max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:700px){.grid{grid-template-columns:1fr}}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18));
    border-radius:16px;padding:22px;min-height:260px;display:flex;flex-direction:column;align-items:center;justify-content:center;
    box-shadow:0 10px 30px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.03);text-align:center;color:#eaf6ff;
    transition:transform .25s ease, box-shadow .25s ease;overflow:visible
  }
  .card:hover{transform:translateY(-8px);box-shadow:0 30px 80px rgba(0,0,0,0.72)}

  h3{font-family:"Orbitron",sans-serif;color:#fff;margin-bottom:6px;text-shadow:0 0 8px var(--neon1),0 0 16px var(--neon2)}

  .emoji-row{font-size:20px;margin:8px 0;display:flex;gap:8px;align-items:center;justify-content:center}
  .emoji-big{font-size:36px;margin:6px 0}
  .info{margin:6px 0;font-size:15px}
  .muted{opacity:0.9;font-size:13px;color:#cfe8ff}

  canvas{width:100% !important;height:160px !important;max-height:220px}

  /* center-block (Pesquisa / Compesa / Lua card) */
  .center-block{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;width:100%}
  .center-block input{width:88%;max-width:520px;border-radius:12px;padding:12px;margin:8px 0;border:none;background:var(--glass);color:#fff;text-align:center;outline:none;font-size:15px;box-shadow:0 0 18px rgba(167,112,239,0.06)}
  .center-block button{cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--neon2));padding:12px 26px;border-radius:14px;border:none;color:#001;font-weight:700;box-shadow:0 0 36px rgba(0,243,255,0.12)}

  .neon-title{font-family:"Orbitron",sans-serif;color:transparent;-webkit-text-stroke:1px rgba(200,150,255,0.95);text-shadow:0 0 6px rgba(200,150,255,0.12),0 0 14px rgba(167,112,239,0.28)}

  /* map */
  #map{height:420px;border-radius:12px;width:100%}

  /* finance grid: 5 columns responsive */
  .grid-finance{display:grid;grid-template-columns:repeat(5,1fr);gap:20px;margin-top:26px}
  @media(max-width:1200px){.grid-finance{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:700px){.grid-finance{grid-template-columns:1fr}}

  .finance-card{min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.18));border:1px solid rgba(255,255,255,0.03);text-align:center}
  .finance-card .divider{width:60%;height:1px;background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));margin:10px 0;border-radius:2px}

  /* news card same size as map */
  .news-card{min-height:420px;display:flex;flex-direction:column;gap:12px;padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.22));border:1px solid rgba(255,255,255,0.03)}
  .news-list{flex:1;overflow:auto;padding-right:8px}
  .news-item{padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px;text-align:left}
  .news-item a{color:#fff;text-decoration:none;font-weight:700}
  .news-item p{color:#dfe8ff;font-size:13px;margin-top:6px}

  /* youtubers grid */
  .yt-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px}
  @media(max-width:900px){.yt-grid{grid-template-columns:1fr}}
  .yt-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));padding:10px;border-radius:10px;display:flex;gap:12px;align-items:center}
  .yt-thumb{width:96px;height:56px;border-radius:8px;background:linear-gradient(90deg,#ff6b6b,#ffb86b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}

  footer{position:fixed;left:0;right:0;bottom:0;padding:10px 12px;text-align:center;background:linear-gradient(90deg,rgba(2,0,15,0.9),rgba(8,0,40,0.9));color:#fff;font-size:14px;z-index:60}

  .audio-player{position:fixed;right:18px;bottom:86px;z-index:70;width:240px;height:64px;border-radius:14px;background:linear-gradient(135deg,rgba(167,112,239,0.12),rgba(0,243,255,0.06));box-shadow:0 12px 40px rgba(0,0,0,0.6);display:flex;align-items:center;gap:12px;padding:12px}
  .small-muted{font-size:12px;color:#cfe8ff;opacity:0.9}
</style>
</head>
<body> 
  <div class="stars" id="stars"></div>

  <header>ğŸŒ™ Oten Lua & Weather â€¢ GÃ³tico GalÃ¡ctico</header>

  <div class="wrap">
    <!-- Top row - forecast cards -->
    <div class="grid">
      <div class="card">
        <h3>ğŸŒ PrevisÃ£o Gramado</h3>
        <div class="emoji-row" id="gramado-emoji-row">ğŸŒ â˜ï¸ ğŸŒ§ï¸ â„ï¸ ğŸŒ™ ğŸ”¥ ğŸ¥¶</div>
        <div class="info" id="gramado-temp">--Â°C</div>
        <div class="muted" id="gramado-desc">Carregando...</div>
        <canvas id="chart-gramado"></canvas>
      </div>

      <div class="card">
        <h3>ğŸŒ PrevisÃ£o SÃ£o Paulo</h3>
        <div class="emoji-row" id="sp-emoji-row">ğŸŒ â˜ï¸ ğŸŒ§ï¸ â„ï¸ ğŸŒ™ ğŸ”¥ ğŸ¥¶</div>
        <div class="info" id="sp-temp">--Â°C</div>
        <div class="muted" id="sp-desc">Carregando...</div>
        <canvas id="chart-sp"></canvas>
      </div>

      <div class="card">
        <h3>ğŸŒ PrevisÃ£o Recife</h3>
        <div class="emoji-row" id="recife-emoji-row">ğŸŒ â˜ï¸ ğŸŒ§ï¸ â„ï¸ ğŸŒ™ ğŸ”¥ ğŸ¥¶</div>
        <div class="info" id="recife-temp">--Â°C</div>
        <div class="muted" id="recife-desc">Carregando...</div>
        <canvas id="chart-recife"></canvas>
      </div>
    </div>

    <!-- Second row (Miami / Santiago / Lisboa) -->
    <div class="grid">
      <div class="card">
        <h3>ğŸŒ PrevisÃ£o Miami</h3>
        <div class="emoji-row" id="miami-emoji-row">ğŸŒ â˜ï¸ ğŸŒ§ï¸ â„ï¸ ğŸŒ™ ğŸ”¥ ğŸ¥¶</div>
        <div class="info" id="miami-temp">--Â°C</div>
        <div class="muted" id="miami-desc">Carregando...</div>
        <canvas id="chart-miami"></canvas>
      </div>

      <!-- Santiago card replaces the previous Lua card's position -->
      <div class="card">
        <h3>ğŸŒ PrevisÃ£o Santiago (CL)</h3>
        <div class="emoji-row" id="santiago-emoji-row">ğŸŒ â˜ï¸ ğŸŒ§ï¸ â„ï¸ ğŸŒ™ ğŸ”¥ ğŸ¥¶</div>
        <div class="info" id="santiago-temp">--Â°C</div>
        <div class="muted" id="santiago-desc">Carregando...</div>
        <canvas id="chart-santiago"></canvas>
      </div>

      <div class="card">
        <h3>ğŸŒ PrevisÃ£o Lisboa</h3>
        <div class="emoji-row" id="lisboa-emoji-row">ğŸŒ â˜ï¸ ğŸŒ§ï¸ â„ï¸ ğŸŒ™ ğŸ”¥ ğŸ¥¶</div>
        <div class="info" id="lisboa-temp">--Â°C</div>
        <div class="muted" id="lisboa-desc">Carregando...</div>
        <canvas id="chart-lisboa"></canvas>
      </div>
    </div>

    <!-- NEW: Lua card in Pesquisa/Compesa style (centered) -->
    <div class="grid">
      <div class="card" style="grid-column: span 3;">
        <div class="center-block">
          <div class="neon-title">ğŸŒ™ Fase da Lua â€” Buscador</div>
          <div class="emoji-big" id="moon-icon">ğŸŒ‘</div>
          <div class="info" id="moon-name">Carregando...</div>
          <div class="muted" id="moon-datetime">--/--/---- â€¢ --:--</div>
          <div class="muted" id="moon-rise-set">Nascer: -- | PÃ´r: --</div>
          <p class="muted" id="moon-phrase" style="margin-top:10px">Frase romÃ¢ntica serÃ¡ exibida aqui.</p>

          <input id="moon-search" placeholder="Buscar cidade para Lua (ex: Gravata, BR)">
          <button onclick="searchMoonCity()">Buscar Lua</button>

          <div style="height:8px"></div>
          <div class="small-muted">A frase romÃ¢ntica muda conforme a fase lunar.</div>
        </div>
      </div>
    </div>

    <!-- Search (Pesquisa) -->
    <div class="grid">
      <div class="card" style="grid-column: span 3;">
        <div class="center-block">
          <div class="neon-title">ğŸ” Pesquisar PrevisÃ£o</div>
          <input id="search" placeholder="Cidade, PaÃ­s (ex: Gravata, BR)">
          <button onclick="searchCity()">Buscar</button>
          <div id="search-result" class="small-muted" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- Compesa (CEP) -->
    <div class="grid">
      <div class="card" style="grid-column: span 3;">
        <div class="center-block">
          <div class="neon-title">ğŸ’§ Compesa â€” Consulta por CEP</div>
          <input id="cep" placeholder="Digite o CEP (ex: 55644-535)">
          <button onclick="checkCompesa()">Consultar</button>
          <p id="compesa-result" class="small-muted" style="margin-top:10px"></p>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div class="grid">
      <div class="card" style="grid-column: span 3;">
        <h3>ğŸŒ Mapa-MÃºndi</h3>
        <div id="map"></div>
      </div>
    </div>

    <!-- Large news card (size of map) -->
    <div class="grid">
      <div class="card news-card" style="grid-column: span 3;">
        <h3>ğŸ“° NotÃ­cias do Mundo â€” Manchetes</h3>
        <div class="news-list" id="news-list">
          <!-- Static example items (you can integrate NewsAPI later) -->
          <div class="news-item"><a href="#" target="_blank">Economia: Mercados globais em movimento apÃ³s anÃºncios</a><p>Principais bolsas reagiram Ã s novas estimativas de inflaÃ§Ã£o e polÃ­tica monetÃ¡ria.</p></div>
          <div class="news-item"><a href="#" target="_blank">Tecnologia: Novas GPUs chegam ao mercado</a><p>Fabricantes anunciam chips voltados a IA e computaÃ§Ã£o de alto desempenho.</p></div>
          <div class="news-item"><a href="#" target="_blank">Clima: Alertas para Ã¡reas costeiras</a><p>Tempestades isoladas previstas â€” autoridades em prontidÃ£o.</p></div>
          <div class="news-item"><a href="#" target="_blank">PolÃ­tica: CÃºpula internacional discute cooperaÃ§Ã£o</a><p>LÃ­deres trataram de energia, comÃ©rcio e seguranÃ§a.</p></div>
        </div>
        <div class="small-muted">Fontes: exemplos estÃ¡ticos â€” substitua por feed real quando desejar.</div>
      </div>
    </div>

    <!-- Finance cards: 3 rows x 5 cols (15 cards) -->
    <div class="grid-finance" id="finance-grid" aria-live="polite">
      <!-- Row 1 -->
      <div class="finance-card"><h3>Intel</h3><div class="divider"></div><div class="muted">INTC â€¢ US$ 34.52</div><div class="info">+1.25%</div></div>
      <div class="finance-card"><h3>Nvidia</h3><div class="divider"></div><div class="muted">NVDA â€¢ US$ 462.18</div><div class="info">+2.84%</div></div>
      <div class="finance-card"><h3>Amazon</h3><div class="divider"></div><div class="muted">AMZN â€¢ US$ 134.11</div><div class="info">+0.56%</div></div>
      <div class="finance-card"><h3>Apple</h3><div class="divider"></div><div class="muted">AAPL â€¢ US$ 182.65</div><div class="info">-0.22%</div></div>
      <div class="finance-card"><h3>Microsoft</h3><div class="divider"></div><div class="muted">MSFT â€¢ US$ 332.89</div><div class="info">+0.74%</div></div>

      <!-- Row 2 -->
      <div class="finance-card"><h3>Nasdaq</h3><div class="divider"></div><div class="muted">NDX â€¢ 15,250 pts</div><div class="info">+0.45%</div></div>
      <div class="finance-card"><h3>DÃ³lar</h3><div class="divider"></div><div class="muted">USD/BRL â€¢ R$ 4.97</div><div class="info">+0.15%</div></div>
      <div class="finance-card"><h3>Ouro</h3><div class="divider"></div><div class="muted">GOLD â€¢ US$ 1,927.50</div><div class="info">-0.18%</div></div>
      <div class="finance-card"><h3>T-Mobile</h3><div class="divider"></div><div class="muted">TMUS â€¢ US$ 139.25</div><div class="info">+0.92%</div></div>
      <div class="finance-card"><h3>Bank of America</h3><div class="divider"></div><div class="muted">BAC â€¢ US$ 29.75</div><div class="info">+0.61%</div></div>

      <!-- Row 3 -->
      <div class="finance-card"><h3>Santander</h3><div class="divider"></div><div class="muted">SANB11 â€¢ R$ 29.80</div><div class="info">+0.25%</div></div>
      <div class="finance-card"><h3>Banco do Brasil</h3><div class="divider"></div><div class="muted">BBAS3 â€¢ R$ 48.90</div><div class="info">-0.10%</div></div>
      <div class="finance-card"><h3>Nubank</h3><div class="divider"></div><div class="muted">NU â€¢ US$ 7.25</div><div class="info">+3.14%</div></div>
      <div class="finance-card"><h3>Wise</h3><div class="divider"></div><div class="muted">WISE â€¢ Â£ 7.32</div><div class="info">+1.02%</div></div>
      <div class="finance-card"><h3>Bitcoin</h3><div class="divider"></div><div class="muted">BTC â€¢ US$ 26,542</div><div class="info">+4.21%</div></div>
    </div>

    <!-- YouTube promotions -->
    <div style="margin-top:22px">
      <h3 style="text-align:center">ğŸ”¥ Promo â€” Principais Canais YouTube</h3>
      <div class="yt-grid" style="margin-top:12px">
        <!-- Brazil -->
        <div class="yt-card"><div class="yt-thumb">BR1</div><div><strong>Canal BR 1</strong><div class="small-muted">Tech & lifestyle</div></div></div>
        <div class="yt-card"><div class="yt-thumb">BR2</div><div><strong>Canal BR 2</strong><div class="small-muted">EducaÃ§Ã£o</div></div></div>
        <div class="yt-card"><div class="yt-thumb">BR3</div><div><strong>Canal BR 3</strong><div class="small-muted">Entretenimento</div></div></div>

        <!-- USA -->
        <div class="yt-card"><div class="yt-thumb">US1</div><div><strong>Channel US 1</strong><div class="small-muted">Tech reviews</div></div></div>
        <div class="yt-card"><div class="yt-thumb">US2</div><div><strong>Channel US 2</strong><div class="small-muted">Finance</div></div></div>
        <div class="yt-card"><div class="yt-thumb">US3</div><div><strong>Channel US 3</strong><div class="small-muted">Science</div></div></div>

        <!-- Europe -->
        <div class="yt-card"><div class="yt-thumb">EU1</div><div><strong>Channel EU 1</strong><div class="small-muted">Documentaries</div></div></div>
        <div class="yt-card"><div class="yt-thumb">EU2</div><div><strong>Channel EU 2</strong><div class="small-muted">Music</div></div></div>
        <div class="yt-card"><div class="yt-thumb">EU3</div><div><strong>Channel EU 3</strong><div class="small-muted">Tech</div></div></div>
      </div>
    </div>

  </div> <!-- wrap -->

  <!-- audio player -->
  <div class="audio-player" id="audio-player">
    <div style="font-size:20px">â™ª</div>
    <div style="flex:1">
      <div style="font-size:13px">Player da Lua</div>
      <div id="audio-track-name" class="small-muted">lua_vozinha.wav</div>
    </div>
    <div><button id="audio-toggle">â–¶</button></div>
  </div>

  <footer>ğŸŒŒ Desenvolvido com ğŸ’œ pela sua Robozinha GalÃ¡ctica Â© 2025</footer>

<script>
/* =========================
   Config - sua chave OpenWeather
   ========================= */
const API_KEY = "582c1a981cd2720482ca8a74be18cd98";

/* =========================
   Stars generator
   ========================= */
const stars = document.getElementById('stars');
for (let i=0;i<220;i++){
  const s = document.createElement('div');
  s.className='star';
  const size = 1 + Math.random()*3;
  s.style.width = s.style.height = size + 'px';
  s.style.left = (Math.random()*100) + '%';
  s.style.top = (Math.random()*100) + '%';
  s.style.animationDuration = (1.2 + Math.random()*4) + 's';
  s.style.opacity = 0.3 + Math.random()*0.9;
  stars.appendChild(s);
}

/* =========================
   Weather emoji helper
   ========================= */
function getWeatherEmoji(desc, temp){
  desc = (desc||'').toLowerCase();
  if(desc.includes('clear') || desc.includes('limpo') || desc.includes('sun')) return temp>30 ? 'â˜€ï¸ ğŸ”¥' : 'â˜€ï¸';
  if(desc.includes('cloud') || desc.includes('nublado') || desc.includes('nuvem')) return temp<10 ? 'â˜ï¸ ğŸ¥¶' : 'â˜ï¸';
  if(desc.includes('rain') || desc.includes('chuva')) return 'ğŸŒ§ï¸';
  if(desc.includes('snow') || desc.includes('neve')) return 'â„ï¸';
  if(desc.includes('thunder') || desc.includes('trovoada')) return 'ğŸŒ©ï¸';
  return 'ğŸŒ¡ï¸';
}

/* =========================
   Load weather + charts
   ========================= */
async function loadWeather(city,country,chartId,tempId,descId,emojiRowId){
  try {
    const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city + (country?','+country:''))}&limit=1&appid=${API_KEY}`);
    const geo = await geoRes.json();
    if(!geo || !geo[0]) {
      document.getElementById(tempId).innerText = city + ': localizaÃ§Ã£o nÃ£o encontrada';
      return;
    }
    const {lat,lon,name} = geo[0];
    const wRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=pt_br`);
    const w = await wRes.json();
    if(!w || !w.list) return;
    const now = w.list[0];
    const temp = now.main.temp;
    document.getElementById(tempId).innerText = `${name}: ${temp.toFixed(1)}Â°C`;
    document.getElementById(descId).innerText = now.weather[0].description;
    // emojis: keep row but highlight relevant emoji first
    const emojiText = getWeatherEmoji(now.weather[0].description,temp) + " â€¢ " + "ğŸŒ â˜ï¸ ğŸŒ§ï¸ â„ï¸ ğŸŒ™ ğŸ¥¶ ğŸ”¥";
    document.getElementById(emojiRowId).innerText = emojiText;

    // chart
    const slice = w.list.slice(0,7);
    const labels = slice.map((d,i)=> i===0 ? 'Agora' : new Date(d.dt*1000).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}));
    const max = slice.map(d=>d.main.temp_max);
    const min = slice.map(d=>d.main.temp_min);
    const ctx = document.getElementById(chartId).getContext('2d');
    if(ctx._chart) ctx._chart.destroy();

    const gradient = ctx.createLinearGradient(0,0,0,160);
    gradient.addColorStop(0,'rgba(167,112,239,0.35)');
    gradient.addColorStop(1,'rgba(0,243,255,0.04)');

    ctx._chart = new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[
        {label:'MÃ¡x',data:max,borderColor:'#ff8da1',backgroundColor:gradient,tension:0.36,fill:true,pointRadius:3,borderWidth:2},
        {label:'MÃ­n',data:min,borderColor:'#7fb7ff',tension:0.36,fill:false,pointRadius:2,borderWidth:2}
      ]},
      options:{
        plugins:{legend:{labels:{color:'#fff'}}},
        scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}},
        elements:{line:{cap:'round'}},
        interaction:{mode:'index',intersect:false}
      }
    });
  }catch(e){ console.error('Erro loadWeather:',e); }
}

/* load default cities */
loadWeather('Gramado','BR','chart-gramado','gramado-temp','gramado-desc','gramado-emoji-row');
loadWeather('SÃ£o Paulo','BR','chart-sp','sp-temp','sp-desc','sp-emoji-row');
loadWeather('Recife','BR','chart-recife','recife-temp','recife-desc','recife-emoji-row');
loadWeather('Miami','US','chart-miami','miami-temp','miami-desc','miami-emoji-row');
loadWeather('Santiago','CL','chart-santiago','santiago-temp','santiago-desc','santiago-emoji-row'); // Santiago here
loadWeather('Lisboa','PT','chart-lisboa','lisboa-temp','lisboa-desc','lisboa-emoji-row');

/* =========================
   Search city (top)
   ========================= */
async function searchCity(){
  const q = document.getElementById('search').value.trim();
  if(!q){ document.getElementById('search-result').innerText = 'Digite uma cidade.'; return; }
  document.getElementById('search-result').innerText = 'Buscando...';
  try{
    const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(q)}&limit=1&appid=${API_KEY}`);
    const geo = await geoRes.json();
    if(!geo || !geo[0]) { document.getElementById('search-result').innerText = 'Cidade nÃ£o encontrada.'; return; }
    const name = geo[0].name + (geo[0].state?(', '+geo[0].state):'') + (geo[0].country?(', '+geo[0].country):'');
    document.getElementById('search-result').innerHTML = `<strong>${name}</strong> â€” lat ${geo[0].lat.toFixed(3)}, lon ${geo[0].lon.toFixed(3)}`;
    if(window.map) map.setView([geo[0].lat,geo[0].lon],6);
  }catch(e){ console.error(e); document.getElementById('search-result').innerText='Erro na busca.'}
}

/* =========================
   Compesa (fake)
   ========================= */
function checkCompesa(){
  const cep = document.getElementById('cep').value.trim();
  if(!cep){ document.getElementById('compesa-result').innerText='Digite um CEP.'; return; }
  const dias = ['Segunda','Quarta','Sexta'];
  const dia = dias[Math.floor(Math.random()*dias.length)];
  document.getElementById('compesa-result').innerText = `PrÃ³ximo abastecimento provÃ¡vel: ${dia}-feira (simulado).`;
}

/* =========================
   Leaflet map
   ========================= */
const map = L.map('map',{attributionControl:true}).setView([-15, -30],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'Â© OpenStreetMap contributors'
}).addTo(map);

// sample markers (centered on SA sample cities)
const sample = [
  {lat:-22.90,lon:-43.20,label:'Rio de Janeiro'},
  {lat:-23.55,lon:-46.63,label:'SÃ£o Paulo'},
  {lat:-8.05,lon:-34.9,label:'Recife'},
  {lat:-8.0,lon:-35.3,label:'Gravata'},
  {lat:-33.45,lon:-70.66,label:'Santiago'}
];
sample.forEach(s=> L.marker([s.lat,s.lon]).addTo(map).bindPopup(`<strong>${s.label}</strong>`));
window.addEventListener('resize',()=> map.invalidateSize());
setTimeout(()=> map.invalidateSize(),700);

/* =========================
   Moon card: SunCalc
   ========================= */
function formatAMPM(date){
  return date.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',hour12:true});
}
function moonPhaseName(phase){
  if(phase===0 || phase===1) return ["Nova","ğŸŒ‘"];
  if(phase>0 && phase<0.25) return ["Crescente","ğŸŒ’"];
  if(Math.abs(phase-0.25)<0.01) return ["Quarto Crescente","ğŸŒ“"];
  if(phase>0.25 && phase<0.5) return ["Crescente Gibosa","ğŸŒ”"];
  if(Math.abs(phase-0.5)<0.01) return ["Cheia","ğŸŒ•"];
  if(phase>0.5 && phase<0.75) return ["Minguante Gibosa","ğŸŒ–"];
  if(Math.abs(phase-0.75)<0.01) return ["Quarto Minguante","ğŸŒ—"];
  return ["Minguante","ğŸŒ˜"];
}

function updateMoonFor(lat,lon,label){
  const now = new Date();
  const moonTimes = SunCalc.getMoonTimes(now, lat, lon);
  const illum = SunCalc.getMoonIllumination(now);
  const [name,emoji] = moonPhaseName(illum.phase);
  document.getElementById('moon-icon').innerText = emoji;
  document.getElementById('moon-name').innerText = `${name} â€¢ ${label||''}`;
  document.getElementById('moon-datetime').innerText = now.toLocaleDateString('pt-BR') + ' â€¢ ' + now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  const rise = moonTimes.rise ? formatAMPM(moonTimes.rise) : 'â€”';
  const setT = moonTimes.set ? formatAMPM(moonTimes.set) : 'â€”';
  document.getElementById('moon-rise-set').innerText = `Nascer: ${rise} | PÃ´r: ${setT}`;
  const phrases = {
    "Cheia":"O teu brilho me torna inteira; olho pra ti e me encho de luz.",
    "Quarto Crescente":"Cada passo teu acende em mim uma nova esperanÃ§a.",
    "Crescente":"CresÃ§o por ti, como a lua que aprende a ser estrela.",
    "Minguante":"Mesmo diminuindo, guardo tudo o que me deste; hÃ¡ beleza em cada lembranÃ§a.",
    "Quarto Minguante":"O silÃªncio entre nÃ³s fala mais que qualquer palavra.",
    "Nova":"Em silÃªncio eu me preparo para voltar a te iluminar."
  };
  const base = phrases[name] || "Meu amor te acompanha em cada noite e em cada suspiro.";
  document.getElementById('moon-phrase').innerText = base;
  // optionally center map to lat/lon
  if(window.map) map.setView([lat,lon],5);
}

// default moon card to Gravata approx coords
updateMoonFor(-8.0,-35.3,"Gravata, BR");

async function searchMoonCity(){
  const q = document.getElementById('moon-search').value.trim();
  if(!q) return alert('Digite cidade (ex: Gravata, BR)');
  try{
    const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(q)}&limit=1&appid=${API_KEY}`);
    const geo = await geoRes.json();
    if(!geo || !geo[0]) return alert('Local nÃ£o encontrado.');
    updateMoonFor(geo[0].lat, geo[0].lon, geo[0].name + (geo[0].country?(', '+geo[0].country):''));
  }catch(e){ console.error(e); alert('Erro ao buscar cidade.') }
}

/* =========================
   Audio player (local file expected near site)
   ========================= */
const audioToggleBtn = document.getElementById('audio-toggle');
const audioTrackName = document.getElementById('audio-track-name');
let audio = new Audio();
audio.src = 'lua_vozinha.wav'; // place this file beside index.html or set a URL
let playing=false;
audioToggleBtn.addEventListener('click', ()=>{
  if(!playing){ audio.play().catch(()=>alert("NÃ£o foi possÃ­vel tocar o Ã¡udio local. Coloque 'lua_vozinha.wav' ao lado do site ou edite audio.src")); audioToggleBtn.innerText='â¸'; playing=true }
  else { audio.pause(); audioToggleBtn.innerText='â–¶'; playing=false }
});
audio.addEventListener('error', ()=>{ audioTrackName.innerText = "arquivo: lua_vozinha.wav (nÃ£o encontrado)"; });

/* =========================
   UX tweaks: map resizing
   ========================= */
map.on('load', ()=> map.invalidateSize());
setTimeout(()=> map.invalidateSize(), 800);

</script>

<audio autoplay loop>
  <source src="assets/musica1.mp3" type="audio/mpeg">
</audio>

</body>
</html>
